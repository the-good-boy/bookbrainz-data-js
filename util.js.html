<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>util.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#autoCreateNewEditionGroup">autoCreateNewEditionGroup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#castDiscardVote">castDiscardVote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createEditionGroupForNewEdition">createEditionGroupForNewEdition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createNote">createNote</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#deleteOauthToken">deleteOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#entityTypes">entityTypes</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#formatDate">formatDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getAddedItems">getAddedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getComparisonFunc">getComparisonFunc</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEditionGroupsCreditedToAuthor">getEditionGroupsCreditedToAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEditionsCreditedToAuthor">getEditionsCreditedToAuthor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntity">getEntity</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModelByType">getEntityModelByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityModels">getEntityModels</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntityParentAlias">getEntityParentAlias</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getEntitySetMetadataByType">getEntitySetMetadataByType</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getOauthToken">getOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRecentImportUtilData">getRecentImportUtilData</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRemovedItems">getRemovedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getUnchangedItems">getUnchangedItems</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#incrementEditorEditCountById">incrementEditorEditCountById</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#loadAuthorNames">loadAuthorNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#parseDate">parseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#promiseProps">promiseProps</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recursivelyGetAreaParentsWithNames">recursivelyGetAreaParentsWithNames</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recursivelyGetRedirectBBID">recursivelyGetRedirectBBID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#saveOauthToken">saveOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateAnnotation">updateAnnotation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateDisambiguation">updateDisambiguation</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateOauthToken">updateOauthToken</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#updateRelationshipSets">updateRelationshipSets</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">util.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.EntityTypeError = void 0;
exports.camelToSnake = camelToSnake;
exports.createEditionGroupForNewEdition = createEditionGroupForNewEdition;
exports.diffRevisions = diffRevisions;
exports.formatDate = formatDate;
exports.parseDate = parseDate;
exports.promiseProps = promiseProps;
exports.snakeToCamel = snakeToCamel;
exports.snakeToCamelID = snakeToCamelID;
exports.truncateTables = truncateTables;
exports.validateEntityType = validateEntityType;
var _padStart2 = _interopRequireDefault(require("lodash/padStart"));
var _sortBy2 = _interopRequireDefault(require("lodash/sortBy"));
var _isArray2 = _interopRequireDefault(require("lodash/isArray"));
var _isString2 = _interopRequireDefault(require("lodash/isString"));
var _snakeCase2 = _interopRequireDefault(require("lodash/snakeCase"));
var _camelCase2 = _interopRequireDefault(require("lodash/camelCase"));
var _reduce2 = _interopRequireDefault(require("lodash/reduce"));
var _deepDiff = require("deep-diff");
function _interopRequireDefault(obj) { return obj &amp;&amp; obj.__esModule ? obj : { default: obj }; }
function snakeToCamel(attrs) {
  return (0, _reduce2.default)(attrs, (result, val, key) => {
    let newKey;
    if (key.indexOf('_') === 0) {
      newKey = `_${(0, _camelCase2.default)(key.substr(1))}`;
    } else {
      newKey = (0, _camelCase2.default)(key);
    }
    result[newKey] = val;
    return result;
  }, {});
}
function snakeToCamelID(attrs) {
  return (0, _reduce2.default)(attrs, (result, val, key) => {
    let newKey;
    if (key.indexOf('_') === 0) {
      newKey = `_${(0, _camelCase2.default)(key.substr(1))}`;
    } else {
      newKey = (0, _camelCase2.default)(key);
    }
    if (newKey !== 'bbid' &amp;&amp; newKey !== 'id') {
      newKey = newKey.replace('Bbid', 'BBID').replace('Id', 'ID');
    }
    result[newKey] = val;
    return result;
  }, {});
}
function camelToSnake(attrs) {
  return (0, _reduce2.default)(attrs, (result, val, key) => {
    let newKey;
    if (key.indexOf('_') === 0) {
      newKey = `_${(0, _snakeCase2.default)(key.substr(1))}`;
    } else {
      newKey = (0, _snakeCase2.default)(key);
    }
    result[newKey] = val;
    return result;
  }, {});
}
class EntityTypeError extends Error {
  constructor(message) {
    super(message);
    this.name = 'EntityTypeError';
    this.message = message;
    this.stack = new Error().stack;
  }
}
exports.EntityTypeError = EntityTypeError;
function validateEntityType(model) {
  if (model.get('_type') !== model.typeId) {
    throw new Error(`Entity ${model.get('bbid')} is not a ${model.typeId}`);
  }
}
async function truncateTables(Bookshelf, tables) {
  for (const table of tables) {
    // eslint-disable-next-line no-await-in-loop
    await Bookshelf.knex.raw(`TRUNCATE ${table} CASCADE`);
  }
}
function diffRevisions(base, other, includes) {
  function diffFilter(path, key) {
    if ((0, _isString2.default)(key)) {
      return key.startsWith('_pivot');
    }
    return false;
  }
  function sortEntityData(data) {
    const aliasesPresent = data.aliasSet &amp;&amp; (0, _isArray2.default)(data.aliasSet.aliases);
    if (aliasesPresent) {
      data.aliasSet.aliases = (0, _sortBy2.default)(data.aliasSet.aliases, 'id');
    }
    const identifiersPresent = data.identifierSet &amp;&amp; (0, _isArray2.default)(data.identifierSet.identifiers);
    if (identifiersPresent) {
      data.identifierSet.identifiers = (0, _sortBy2.default)(data.identifierSet.identifiers, ['value', 'type.label']);
    }
    const relationshipsPresent = data.relationshipSet &amp;&amp; (0, _isArray2.default)(data.relationshipSet.relationships);
    if (relationshipsPresent) {
      data.relationshipSet.relationships = (0, _sortBy2.default)(data.relationshipSet.relationships, 'id');
    }
    return data;
  }
  const baseDataPromise = base.related('data').fetch({
    require: false,
    withRelated: includes
  });
  if (!other) {
    return baseDataPromise.then(baseData => (0, _deepDiff.diff)({}, baseData ? sortEntityData(baseData.toJSON()) : {}, diffFilter));
  }
  const otherDataPromise = other.related('data').fetch({
    require: false,
    withRelated: includes
  });
  return Promise.all([baseDataPromise, otherDataPromise]).then(([baseData, otherData]) => (0, _deepDiff.diff)(otherData ? sortEntityData(otherData.toJSON()) : {}, baseData ? sortEntityData(baseData.toJSON()) : {}, diffFilter));
}
const YEAR_STR_LENGTH = 6;
const MONTH_STR_LENGTH = 2;
const DAY_STR_LENGTH = 2;

/**
 * Produce an ISO 8601-2004 formatted string for a date.
 * @param {number} year - A calendar year.
 * @param {number} [month] - A calendar month.
 * @param {number} [day] - A calendar day of month.
 * @returns {string} The provided date formatted as an ISO 8601-2004 year or calendar
 *                   date.
 */
function formatDate(year, month, day) {
  if ((!year || isNaN(parseInt(year, 10))) &amp;&amp; year !== 0) {
    return null;
  }
  const isCommonEraDate = Math.sign(year) === 1 || Math.sign(year) === 0;
  // eslint-disable-next-line max-len
  const yearString = `${isCommonEraDate ? '+' : '-'}${(0, _padStart2.default)(Math.abs(year).toString(), YEAR_STR_LENGTH, '0')}`;
  if (!month || isNaN(parseInt(month, 10))) {
    return `${yearString}`;
  }
  const monthString = (0, _padStart2.default)(month.toString(), MONTH_STR_LENGTH, '0');
  if (!day || isNaN(parseInt(day, 10))) {
    return `${yearString}-${monthString}`;
  }
  const dayString = (0, _padStart2.default)(day.toString(), DAY_STR_LENGTH, '0');
  return `${yearString}-${monthString}-${dayString}`;
}

/**
 * Split ISO 8601 calendar dates or years into a numerical array.
 * @param {string} date - A date of the format 'YYYY', 'YYYY-MM', or
 *                        'YYYY-MM-DD'.
 * @returns {number[]} Year, month, and day of month respectively.
 */
function parseDate(date) {
  if (!date) {
    return [null, null, null];
  }
  const parts = date.toString().split('-');
  // A leading minus sign denotes a BC date
  // This creates an empty part that needs to be removed,
  // and requires us to add the negative sign back for the year
  // We ensure parts[0] is a number and not for example an empty string
  if (parts[0] === '') {
    parts.shift();
    parts[0] = -parseInt(parts[0], 10);
  }
  // Incorrect format
  if (parts.length &lt; 1 || parts.length > 3) {
    return [null, null, null];
  }
  let padding = [];
  if (parts.length === 1) {
    padding = [null, null];
  } else if (parts.length === 2) {
    padding = [null];
  }
  return parts.map(part => {
    const parsed = parseInt(part, 10);
    return isNaN(parsed) ? null : parsed;
  }).concat(padding);
}

/**
 * Create a new Edition Group for an Edition.
 * The Edition Group will be part of the same revision, and will have the same
 * alias set and author credit for that revision
 * Subsequent changes to the alias set or author credit for either entity will
 * only impact that entity's new revision.
 * @param {object} orm - The Bookshelf ORM
 * @param {object} transacting - The Bookshelf/Knex SQL transaction in progress
 * @param {number|string} aliasSetId - The id of the new edition's alias set
 * @param {number|string} revisionId - The id of the new edition's revision
 * @param {number|string} authorCreditId - The id of the new edition's author credit
 * @returns {string} BBID of the newly created Edition Group
 */
async function createEditionGroupForNewEdition(orm, transacting, aliasSetId, revisionId, authorCreditId) {
  const Entity = orm.model('Entity');
  const EditionGroup = orm.model('EditionGroup');
  const newEditionGroupEntity = await new Entity({
    type: 'EditionGroup'
  }).save(null, {
    method: 'insert',
    transacting
  });
  const bbid = newEditionGroupEntity.get('bbid');
  await new EditionGroup({
    aliasSetId,
    authorCreditId,
    bbid,
    revisionId
  }).save(null, {
    method: 'insert',
    transacting
  });
  return bbid;
}

/**
 * Replacement for Bluebird's Promise.props
 * @param {Object} promiseObj - an object containing string keys and promises
 *                              to be resolved as the values
 * @returns {Object} an object containing the same keys, but resolved promises
 */
async function promiseProps(promiseObj) {
  const resolvedKeyValuePairs = await Promise.all(Object.entries(promiseObj).map(([key, val]) => Promise.resolve(val).then(x => [key, x])));
  return Object.fromEntries(resolvedKeyValuePairs);
}</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu May 18 2023 13:04:44 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
